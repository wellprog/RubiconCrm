
rcmail.tb_label_no="";function rcmail_tb_label_menu(a){if(typeof rcmail_ui=="undefined"){rcmail_ui=UI}if(!rcmail_ui.check_tb_popup()){rcmail_ui.tb_label_popup_add()}if(typeof rcmail_ui.show_popupmenu=="undefined"){rcmail_ui.show_popup("tb_label_popup")}else{rcmail_ui.show_popupmenu("tb_label_popup")}return false}function rcm_tb_label_insert(b,e){if(typeof rcmail.env=="undefined"||typeof rcmail.env.messages=="undefined"){return}var c=rcmail.env.messages[b];var d=$(e.obj);d.find("td.subject").append("<span class='tb_label_dots'></span>");if(c.flags&&c.flags.tb_labels){if(c.flags.tb_labels.length){var a=d.find("td.subject span.tb_label_dots");c.flags.tb_labels.sort(function(g,f){return g-f});if(rcmail.env.tb_label_style=="bullets"){for(idx in c.flags.tb_labels){a.append("<span class='label"+c.flags.tb_labels[idx]+"'>&#8226;</span>")}}else{for(idx in c.flags.tb_labels){d.addClass("label"+c.flags.tb_labels[idx])}}}}}function rcm_tb_label_submenu(a){if(typeof rcmail_ui=="undefined"){rcmail_ui=UI}rcm_tb_label_create_popupmenu();if(!rcmail_ui.check_tb_popup()){rcmail_ui.tb_label_popup_add()}if(typeof rcmail_ui.show_popupmenu=="undefined"){rcmail_ui.show_popup("tb_label_popup")}else{rcmail_ui.show_popupmenu("tb_label_popup")}return false}function rcm_tb_label_flag_toggle(a,d,b){var e=$("table.headers-table");var c=$("#messagecontframe");if(c.length){tb_labels_for_message=c.get(0).contentWindow.tb_labels_for_message;e=c.contents().find("table.headers-table")}if(!rcmail.message_list&&!e){return}if(e.length&&a.length){if(b==true){if(rcmail.env.tb_label_style=="bullets"){$("#labelbox").append("<span class='tb_label_span"+d+"'>"+rcmail.env.tb_label_custom_labels[d]+"</span>")}else{e.addClass("label"+d)}tb_labels_for_message.push(d)}else{if(rcmail.env.tb_label_style=="bullets"){$("span.tb_label_span"+d).remove()}else{e.removeClass("label"+d)}var f=jQuery.inArray(d,tb_labels_for_message);if(f>-1){tb_labels_for_message.splice(f,1)}}if(!rcmail.env.messages){return}}jQuery.each(a,function(g,j){var k=rcmail.env.messages[j];var m=rcmail.message_list.rows[j];if(b==true){var l=$(m.obj);var h=l.find("td.subject span.tb_label_dots");if(rcmail.env.tb_label_style=="bullets"){h.append("<span class='label"+d+"'>&#8226;</span>")}else{l.addClass("label"+d)}k.flags.tb_labels.push(d)}else{var l=$(m.obj);if(rcmail.env.tb_label_style=="bullets"){l.find("td.subject span.tb_label_dots span.label"+d).remove()}else{l.removeClass("label"+d)}var n=jQuery.inArray(d,k.flags.tb_labels);if(n>-1){k.flags.tb_labels.splice(n,1)}}})}function rcm_tb_label_flag_msgs(a,b){rcm_tb_label_flag_toggle(a,b,true)}function rcm_tb_label_unflag_msgs(b,a){rcm_tb_label_flag_toggle(b,a,false)}function rcm_tb_label_get_selection(){var a=rcmail.message_list?rcmail.message_list.get_selection():[];if(a.length==0&&rcmail.env.uid){a=[rcmail.env.uid,]}return a}function rcm_tb_label_create_popupmenu(){for(i=0;i<6;i++){var a=$("li.label"+i+" a");var b=rcm_tb_label_get_selection();if(b.length==0){a.removeClass("active")}else{a.addClass("active")}}}function rcm_tb_label_init_onclick(){for(i=0;i<6;i++){var a=$("#tb_label_popup li.label"+i+" a");a.unbind("click");a.click(function(){var g=$(this).parent().attr("class");var d=parseInt(g.replace("label",""));var l=rcm_tb_label_get_selection();if(!l.length){return}var j=d;var k=d+1;var b=false;if(d==0){j=1;k=6;b=true}for(i=j;i<k;i++){g="label"+i;d=i;var e="on";if(rcmail.env.messages){var f=rcmail.env.messages[l[0]];if(f.flags&&jQuery.inArray(d,f.flags.tb_labels)>=0){e="off"}else{e="on"}}else{if(jQuery.inArray(d,tb_labels_for_message)>=0){e="off"}}var c=[];var h=[];jQuery.each(l,function(p,q){if(!rcmail.env.messages){if(e=="on"){c.push(q)}else{h.push(q)}if(b&&h.length==0){h.push(q)}return}var r=rcmail.env.messages[q];if(r.flags&&jQuery.inArray(d,r.flags.tb_labels)>=0){if(e=="off"){h.push(q)}}else{if(e=="on"){c.push(q)}}});if(b){c=[]}if(c.length==0&&h.length==0){continue}var o=c.join(",");var n=h.join(",");var m=rcmail.set_busy(true,"loading");rcmail.http_request("plugin.thunderbird_labels.set_flags","_flag_uids="+o+"&_unflag_uids="+n+"&_mbox="+urlencode(rcmail.env.mailbox)+"&_toggle_label="+g,m);rcm_tb_label_flag_msgs(c,d);rcm_tb_label_unflag_msgs(h,d)}})}}function rcmail_ctxm_label(d,c,e){var b=rcmail.message_list?rcmail.message_list.get_selection():[];if(!b.length&&!rcmail.env.uid){return}if(!b.length&&rcmail.env.uid){rcmail.message_list.select_row(rcmail.env.uid)}var a=$("#tb_label_popup li.label"+rcmail.tb_label_no+" a");if(a){a.click()}return}function rcmail_ctxm_label_set(a){rcmail.tb_label_no=a}$(document).ready(function(){rcm_tb_label_init_onclick();if(rcmail.env.tb_label_enable_shortcuts){$(document).keyup(function(f){var c=f.which;if((c>47&&c<58)||(c>95&&c<106)){var d=c%48;var b=$("#tb_label_popup li.label"+d+" a");if(b){b.click()}}})}if(window.rcm_contextmenu_register_command){rcm_contextmenu_register_command("ctxm_tb_label",rcmail_ctxm_label,$("#tb_label_ctxm_mainmenu"),"moreacts","after",true)}if(window.tb_labels_for_message){var a=$("div.message-headers");if(!a.length){a=$("table.headers-table tbody tr:first-child")}a.append("<div id='labelbox'></div>");tb_labels_for_message.sort(function(d,c){return d-c});jQuery.each(tb_labels_for_message,function(b,c){rcm_tb_label_flag_msgs([-1,],c)})}rcmail.addEventListener("insertrow",function(b){rcm_tb_label_insert(b.uid,b.row)});rcmail.addEventListener("init",function(b){rcmail.register_command("plugin.thunderbird_labels.rcm_tb_label_submenu",rcm_tb_label_submenu,rcmail.env.uid);if(rcmail.message_list){rcmail.message_list.addEventListener("select",function(c){rcmail.enable_command("plugin.thunderbird_labels.rcm_tb_label_submenu",c.get_selection().length>0)})}});if(window.rcube_mail_ui){rcube_mail_ui.prototype.tb_label_popup_add=function(){add={tb_label_popup:{id:"tb_label_popup"}};this.popups=$.extend(this.popups,add);var b=$("#"+this.popups.tb_label_popup.id);if(b.length){this.popups.tb_label_popup.obj=b}else{delete this.popups.tb_label_popup}}}if(window.rcube_mail_ui){rcube_mail_ui.prototype.check_tb_popup=function(){if(typeof this.popups=="undefined"){return true}if(this.popups.tb_label_popup){return true}else{return false}}}});